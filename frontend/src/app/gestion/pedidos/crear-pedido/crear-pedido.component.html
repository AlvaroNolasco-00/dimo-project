<div class="crear-pedido-container">
  <div class="form-card">
    <div class="form-header">
      <h1>Crear Nuevo Pedido</h1>
      <p>Ingresa la información detallada para registrar un nuevo pedido.</p>
    </div>

    <form (ngSubmit)="guardarPedido()">
      <div class="form-row">
        <div class="form-group">
          <label for="cliente">Nombre del Cliente</label>
          <div class="input-wrapper">
            <i class="ph ph-user"></i>
            <input type="text" id="cliente" [(ngModel)]="nuevoPedido.cliente" name="cliente"
              placeholder="Ej. Empresas Polar" required>
          </div>
        </div>

        <div class="form-group">
          <label for="fecha">Fecha de Entrega</label>
          <div class="input-wrapper">
            <i class="ph ph-calendar"></i>
            <input type="date" id="fecha" [(ngModel)]="nuevoPedido.fechaEntrega" name="fecha" required>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="form-group full-width">
        <label for="ubicacion">Lugar de Entrega</label>
        <p class="helper-text">Busca una dirección o selecciona el punto en el mapa.</p>

        <div class="search-box">
          <div class="input-wrapper">
            <i class="ph ph-magnifying-glass"></i>
            <input type="text" [(ngModel)]="searchQuery" name="searchQuery"
              placeholder="Buscar dirección (Ej. Av. Reforma 222, CDMX)"
              (keydown.enter)="$event.preventDefault(); searchAddress()">
          </div>
          <button type="button" class="btn-search" (click)="searchAddress()">
            Buscar
          </button>
        </div>

        <div id="map" class="map-container"></div>

        <div class="selected-address" *ngIf="nuevoPedido.direccion">
          <i class="ph ph-map-pin"></i>
          <span>{{ nuevoPedido.direccion }}</span>
        </div>
      </div>

      <!-- STATES SECTION -->
      <div class="form-row">
        <div class="form-group">
          <label for="etapa">Etapa Inicial</label>
          <div class="input-wrapper">
            <i class="ph ph-steps"></i>
            <select id="etapa" [(ngModel)]="nuevoPedido.current_state_id" name="etapa" required
              [disabled]="isLoadingStates">
              <option *ngIf="isLoadingStates" [ngValue]="null">Cargando etapas...</option>
              <option *ngFor="let state of projectStates" [value]="state.id">{{ state.name }}</option>
            </select>
            <i class="ph ph-caret-down select-icon"></i>
          </div>
        </div>
      </div>

      <!-- ITEMS SECTION -->
      <div class="form-group full-width items-section">
        <h3>Detalle del Pedido</h3>

        <!-- Add Item Form -->
        <!-- Composite Item Builder -->
        <div class="add-item-container">
          <h4>Construir Item Compuesto</h4>
          <p class="helper-text-sm">Agrega los componentes que conforman este item (ej. 1 Camisa + 1 Estampado)</p>

          <!-- Sub-item Form -->
          <div class="add-item-grid sub-item-grid">
            <div class="form-group grid-type">
              <label>Tipo de Costo</label>
              <div class="input-wrapper">
                <i class="ph ph-tag"></i>
                <select [(ngModel)]="tempSubItem.cost_type_id" name="subCostType" (change)="onCostTypeChange()"
                  [disabled]="isLoadingTypes">
                  <option [ngValue]="null" disabled selected>Tipo</option>
                  <option *ngIf="isLoadingTypes" [ngValue]="null" disabled>Cargando...</option>
                  <option *ngFor="let type of costTypes" [value]="type.id">{{ type.name }}</option>
                </select>
              </div>
            </div>

            <div class="form-group grid-item">
              <label>Item / Costo</label>
              <div class="input-wrapper">
                <i class="ph ph-package"></i>
                <select [(ngModel)]="tempSubItem.operative_cost_id" name="subOpCost"
                  [disabled]="!tempSubItem.cost_type_id || isLoadingCosts" (change)="onOperativeCostChange()">
                  <option [ngValue]="null" disabled selected>Selecciona opción</option>
                  <option *ngIf="isLoadingCosts" [ngValue]="null" disabled>Cargando...</option>
                  <option *ngFor="let cost of availableOperativeCosts" [ngValue]="cost.id">
                    {{ cost.base_cost | currency }}
                    <span *ngIf="cost.attributes">
                      - <span *ngFor="let attr of cost.attributes | keyvalue">{{ attr.key }}: {{ attr.value }} </span>
                    </span>
                  </option>
                </select>
              </div>
            </div>

            <div class="form-group grid-qty">
              <label>Cant.</label>
              <div class="input-wrapper">
                <i class="ph ph-hash"></i>
                <input type="number" placeholder="1" [(ngModel)]="tempSubItem.quantity" name="subItemQty" min="1">
              </div>
            </div>

            <div class="form-group grid-button">
              <label>&nbsp;</label>
              <button type="button" class="btn-secondary" (click)="addSubItem()"
                [disabled]="!tempSubItem.operative_cost_id || tempSubItem.quantity <= 0">
                <i class="ph ph-plus"></i> Componente
              </button>
            </div>
          </div>

          <!-- Current Composite Item Preview -->
          <div class="composite-preview" *ngIf="newItem.subItems.length > 0">
            <div class="sub-items-list">
              <h5>Componentes del Item:</h5>
              <ul>
                <li *ngFor="let sub of newItem.subItems; let i = index">
                  <span>{{ sub.quantity }}x {{ sub.description }} ({{ sub.unit_price | currency }})</span>
                  <button type="button" class="btn-icon-danger small" (click)="removeSubItem(i)">
                    <i class="ph ph-x"></i>
                  </button>
                </li>
              </ul>
            </div>

            <div class="composite-actions">
              <div class="form-group">
                <label>Cantidad de Items Compuestos</label>
                <div class="input-wrapper">
                  <i class="ph ph-copy"></i>
                  <input type="number" [(ngModel)]="newItem.quantity" name="compositeQty" min="1">
                </div>
              </div>

              <div class="composite-summary">
                <p><strong>Precio Unitario (Compuesto):</strong> {{ newItem.unit_price | currency }}</p>
                <p><strong>Subtotal Total:</strong> {{ newItem.quantity * newItem.unit_price | currency }}</p>
              </div>

              <div class="action-buttons-wrapper">
                <button *ngIf="editingItemIndex !== null" type="button" class="btn-cancel-edit" (click)="cancelEdit()">
                  <i class="ph ph-x"></i> Cancelar Edición
                </button>

                <button type="button" class="btn-add-item primary" (click)="addItem()">
                  <i class="ph" [class.ph-check]="editingItemIndex === null"
                    [class.ph-pencil-simple]="editingItemIndex !== null"></i>
                  {{ editingItemIndex !== null ? 'Actualizar Item' : 'Agregar al Pedido' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Items List -->
        <div class="items-table-wrapper" *ngIf="items.length > 0">
          <table class="items-table">
            <thead>
              <tr>
                <th>Descripción</th>
                <th>Cant.</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of items; let i = index">
                <td>
                  <strong>{{ item.description }}</strong>
                  <div class="item-details-small" *ngIf="item.attributes?.sub_items">
                    <span *ngFor="let sub of item.attributes.sub_items">
                      • {{ sub.quantity }}x {{ sub.description }} <br>
                    </span>
                  </div>
                </td>
                <td>{{ item.quantity }}</td>
                <td>${{ item.unit_price | number:'1.2-2' }}</td>
                <td>${{ item.subtotal | number:'1.2-2' }}</td>
                <td>
                  <div class="table-actions">
                    <button type="button" class="btn-icon-secondary" (click)="editItem(i)">
                      <i class="ph ph-pencil-simple"></i>
                    </button>
                    <button type="button" class="btn-icon-danger" (click)="removeItem(i)">
                      <i class="ph ph-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="text-right"><span class="total-label">Subtotal del Pedido:</span></td>
                <td colspan="2" class="total-amount">${{ totalAmount | number:'1.2-2' }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="form-group full-width">
        <label for="notas">Notas Adicionales</label>
        <div class="input-wrapper textarea-wrapper">
          <i class="ph ph-note-pencil"></i>
          <textarea id="notas" [(ngModel)]="nuevoPedido.notas" name="notas" rows="4"
            placeholder="Información relevante sobre el pedido..."></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" (click)="cancelar()" [disabled]="isSaving">
          Cancelar
        </button>
        <button type="submit" class="btn-save" [disabled]="items.length === 0 || isSaving"
          [class.btn-loading]="isSaving">
          <span class="spinner" *ngIf="isSaving"></span>
          <i class="ph ph-floppy-disk" *ngIf="!isSaving"></i>
          Guardar Pedido
        </button>
      </div>
    </form>
  </div>
</div>