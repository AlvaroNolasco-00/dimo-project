<div class="costos-operativos-container">
  <h1>Costos Operativos</h1>
  <p>Aquí podrás gestionar y visualizar todos los costos operativos del negocio.</p>

  <div class="actions-bar" style="margin-bottom: 20px;">
    <button class="btn-primary" (click)="openTypeModal()">+ Nuevo Tipo de Gasto</button>
  </div>

  <div class="costs-container">
    @for (type of costTypes; track type.id) {
    <div class="section">
      <div class="section-header">
        <h2>{{ type.name }}</h2>
        <small>{{ type.description }}</small>
      </div>
      <div class="table-responsive">
        <table>
          <thead>
            <tr>
              @for (col of typeColumns[type.id]; track col) {
              <th>{{ col | titlecase }}</th>
              }
              <th>Costo Base</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (cost of groupedCosts[type.id]; track cost.id) {
            <tr>
              @for (col of typeColumns[type.id]; track col) {
              <td>
                {{ cost.attributes[col] }}
              </td>
              }
              <td>{{ cost.base_cost | currency }}</td>
              <td class="text-right">
                <button class="btn-edit" (click)="editCost(cost)">Editar</button>
                @if (isAdmin) {
                <button class="btn-danger" (click)="deleteCost(cost.id)" style="margin-left: 8px;">Eliminar</button>
                }
              </td>
            </tr>
            } @empty {
            <tr>
              <td [attr.colspan]="(typeColumns[type.id]?.length || 0) + 2" class="text-center">
                No hay costos registrados.
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      <div class="section-footer">
        <button class="btn-add" (click)="openCostModal(type.id)">Agregar costo a {{type.name}}</button>
      </div>
    </div>
    }
  </div>
</div>

<!-- Modal: New Cost Type -->
@if (showTypeModal) {
<div class="modal-backdrop">
  <div class="modal-content">
    <h2>Nuevo Tipo de Gasto</h2>
    <div class="form-group">
      <label>Nombre (Ej: "Camisas", "Estampados")</label>
      <input type="text" [(ngModel)]="newTypeName" class="form-control">
    </div>
    <div class="form-group">
      <label>Descripción</label>
      <input type="text" [(ngModel)]="newTypeDesc" class="form-control">
    </div>
    <div class="modal-actions">
      <button (click)="closeTypeModal()" class="btn-secondary">Cancelar</button>
      <button (click)="saveType()" class="btn-primary" [disabled]="!newTypeName">Guardar</button>
    </div>
  </div>
</div>
}

<!-- Modal: New Cost -->
@if (showCostModal) {
<div class="modal-backdrop">
  <div class="modal-content">
    <h2>{{ editingCostId ? 'Editar' : 'Agregar' }} Costo</h2>
    <div class="form-group">
      <label>Costo Base</label>
      <input type="number" [(ngModel)]="newCostBase" class="form-control">
    </div>

    <h3>Atributos</h3>
    <div class="attributes-list">
      @for (attr of newCostAttributes; track i; let i = $index) {
      <div class="attribute-row">
        <input type="text" [(ngModel)]="attr.key" placeholder="Nombre (ej: Talla)" class="form-control">
        <input type="text" [(ngModel)]="attr.value" placeholder="Valor (ej: XL)" class="form-control">
        <button (click)="removeAttribute(i)" class="btn-danger">X</button>
      </div>
      }
      <button (click)="addAttribute()" class="btn-secondary btn-sm">+ Agregar Atributo</button>
    </div>

    <div class="modal-actions">
      <button (click)="closeCostModal()" class="btn-secondary">Cancelar</button>
      <button (click)="saveCost()" class="btn-primary">Guardar</button>
    </div>
  </div>
</div>
}