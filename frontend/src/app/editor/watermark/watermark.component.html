<header>
    <h1>Marca de Agua</h1>
    <p>Agrega tu logo o marca de agua a tus imágenes.</p>
</header>

<div class="editor-area">
    <div class="controls-sidebar">
        <div class="control-group">
            <label>1. Imagen Base</label>
            <button class="btn secondary" (click)="triggerBaseUpload()">
                <i class="ph ph-image"></i> {{ baseImageSrc() ? 'Cambiar Imagen' : 'Subir Imagen' }}
            </button>
            <input #fileInputBase type="file" (change)="onBaseSelected($event)" accept="image/*" hidden>
        </div>

        <div class="control-group" *ngIf="baseImageSrc()">
            <label>2. Logo / Marca</label>
            <button class="btn secondary" (click)="triggerWatermarkUpload()">
                <i class="ph ph-stamp"></i> {{ watermarkImageSrc() ? 'Cambiar Logo' : 'Subir Logo' }}
            </button>
            <input #fileInputWatermark type="file" (change)="onWatermarkSelected($event)" accept="image/*" hidden>
            <p class="hint" *ngIf="watermarkImageSrc()">El logo se ha redimensionado automáticamente (max 300px).</p>
        </div>

        <!-- Enhance Controls -->
        <div class="control-group" *ngIf="baseImageSrc() && watermarkImageSrc()">
            <label>3. Ajustes</label>

            <div class="sub-control">
                <label>Tamaño ({{ (wmScale() * 100).toFixed(0) }}%)</label>
                <input type="range" min="0.1" max="1.5" step="0.05" [ngModel]="wmScale()"
                    (ngModelChange)="wmScale.set($event); drawCanvas()">
            </div>

            <div class="sub-control">
                <label>Forma</label>
                <select [ngModel]="wmShape()" (ngModelChange)="wmShape.set($event); drawCanvas()">
                    <option value="original">Original</option>
                    <option value="circle">Círculo</option>
                    <option value="square">Cuadrado</option>
                    <option value="rect-4-3">Rectángulo (4:3)</option>
                    <option value="rect-3-4">Rectángulo (3:4)</option>
                </select>
            </div>
        </div>

        <div class="action-buttons" *ngIf="baseImageSrc() && watermarkImageSrc()">
            <button class="btn primary full-width" (click)="process()" [disabled]="isLoading() || !!resultImageSrc()">
                <i class="ph ph-spinner spinner" *ngIf="isLoading()"></i>
                {{ isLoading() ? 'Procesando...' : 'Aplicar Marca' }}
            </button>

            <!-- Moved Actions -->
            <div class="post-process-actions" *ngIf="resultImageSrc() || isLoading()">
                <a [href]="resultImageSrc()" [download]="downloadFilename()" class="btn download full-width"
                    [class.disabled]="!resultImageSrc()">
                    <i class="ph ph-download"></i> Descargar
                </a>
                <button class="btn secondary full-width" (click)="resultImageSrc.set(null)" [disabled]="isLoading()">
                    <i class="ph ph-arrow-left"></i> Volver a Editar
                </button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <!-- Canvas/Preview Container -->
        <div class="canvas-container" [class.hidden]="resultImageSrc()">
            <p *ngIf="!baseImageSrc()" class="empty-state">Sube una imagen base para comenzar</p>
            <canvas #editorCanvas (mousedown)="onMouseDown($event)" (mousemove)="onMouseMove($event)"
                (mouseup)="onMouseUp()" (mouseleave)="onMouseUp()"
                [style.cursor]="watermarkImageSrc() ? 'move' : 'default'">
            </canvas>
        </div>

        <!-- Result View -->
        <div class="result-container" *ngIf="resultImageSrc()">
            <h3>Resultado</h3>
            <img [src]="resultImageSrc()" alt="Resultado">
        </div>
    </div>
</div>